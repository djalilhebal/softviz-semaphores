<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href="index.css" rel="stylesheet" />
  <title>Semaphores: Traffic Sim</title>
</head>
<body>
  <header>
    <h1>Semaphores: Traffic Sim</h1>
    <p class="subtitle">Nerdyfying a college course exercise <i>#ConcurrentProgramming #Visualization</i></p>
  </header>
  <main>
    <form id="inputs" autocomplete="off" spellcheck="false">
      <fieldset>

        <div id="user-vars">
          <b>Globally defined variables</b><br />

          <b>Semaphores</b>
            {<input id="sema-names" type="text"
              placeholder="comma-separated identifiers"
              pattern="([A-Za-z$_][A-Za-z0-9$_]*)?(\s*,\s*([A-Za-z$_][A-Za-z0-9$_]*))*"
              value="sLight1, sLight2, sEmpty1, sEmpty2"
            />}
            =
            {<input id="sema-vals" type="text"
              placeholder="comma-separated integers"
              pattern="\d?(\s*,\s*\d)*"
              value="1, 0, 1, 1"
            />}

          <br />

          <b>Integers</b>
            {<input id=int-names type="text"
              placeholder="comma-separated identifiers"
              pattern="light(\s*,\s*([A-Za-z$_][A-Za-z0-9$_]*))*"
              value="light"
            />}
            =
            {<input id="int-vals" type="text"
              placeholder="comma-separated integers"
              pattern="[12](\s*,\s*\d)*"
              value="1"
            />}
          <br>
          <strong>* <code>light</code> must be in <code>{1, 2}</code></strong>
        </div>

        <fieldset id="user-algorithms">
          <legend>Algorithms</legend>

<label>Controller
<textarea id="controller">while (1) {
  sleep(15) //interval
  if (light == 1) {
    p(sLight1)
    light = 2
    v(sLight2)
  } else {
    p(sLight2)
    light = 1
    v(sLight1)
  }
}</textarea>
</label>

<label>Traverser1
<textarea id="traverser1">p(sEmpty1)
p(sLight1)
traverse()
v(sLight1)
v(sEmpty1)</textarea>
</label>

<label>Traverser2
<textarea id="traverser2">p(sEmpty2)
p(sLight2)
traverse()
v(sLight2)
v(sEmpty2)</textarea>
</label>

</fieldset>

        <div id="buttons">
          <button id="btn-start" type="submit">Start!</button>
          <button id="btn-stop" disabled>Stop</button>
          <button id="btn-load-attempt">Load my attempt</button>
          <button id="btn-load-correct">Load correct solution</button>
        </div>

      </fieldset>
    </form>

    <output id="sim" role="img" form="inputs"
            data-light="0" data-ctrl-queued="false" data-state="normal">
      <span id="light-1" title="light == 1"></span>
      <div id="lane-1" title="lane #1"></div>

      <div id="intersection" title="intersection"></div>

      <span id="light-2" title="light == 2"></span>
      <div id="lane-2" title="lane #2"></div>
    </output>

  </main>

  <section>
    <h2>Exercice</h2>
    <pre>
      <i lang="fr"></i>En français: <a hreflang="fr" href="https://lipn.univ-paris13.fr/~fouquere/ENSEIGNEMENT/L2SR/TDTP_Systemes/td6.pdf">Exercice 2. Synchronisation : la circulation</a> (<a href="https://web.archive.org/web/20191228014022/https://lipn.univ-paris13.fr/~fouquere/ENSEIGNEMENT/L2SR/TDTP_Systemes/td6.pdf">#archivé</a>)</i>


    <b>Traffic Lights:</b>
    At an intersection, traffic is controlled by traffic lights (also known as "semaphores).

    Rules:
    - The intersection can contain at most one vehicle.
    - Vehicles arrive at both roads in a random manner.
    - Traffic lights of each road periodically change color (red or green), and hold that color for a finite period of time.
    - The traffic lights controller (Controller) should wait <em>only for the current vehicle</em> at the intersection to leave before changing lights.

    For the sake of simplicity, we assume that:
    - it is an intersection of two one-lane roads
    - vehicles don't change direction, and keep moving in a straight line

    This system can be modeled as a set of parallel processes:
    - A process <b>P</b> that executes the Controller procedure which handles both traffic lights.
    - A process for each vehicle (Traverser<sub>i</sub> if on voie<sub>i</sub>; where i = {1, 2})
    - The traffic light of lane<sub>i</sub> is green when <code>light == i</code>.
    (Hint: Traffic lights display a yellow circle when 'Controller' is blocked on a semaphore)

    <strong>Predefined functions</strong>: <code>p(sema)</code>, <code>v(sema)</code>, <code>sleep(secs)</code>, in addition to Traverser's <code>traverse()</code>.

    Write <b>Controller</b>, as well as the <b>Traverser1</b> and <b>Traverser2</b> procedures to synchronize the system using semaphores.

    <i>Gambatte~</i>
    </pre>
  </section>
  
  <section>
    <h2>Warnings</h2>
    <pre>
    - For technical reasons, you need to call <code>sleep(0)</code> if you're going to use an "active wait" loop of some kind that does not contain any call to our predefined functions.

    - The 'stop' and 'restart' functionalities are not fully implemented and so you will need to refresh the page to test different algorithms (TO BE FIXED later).
    (You can still call <code>Sim.stop()</code> from the console and it will kinda work.)

    - Keep this in mind if you're using loops and conditionals:
    Sorting each road's vehicles with multiple dynamic queues (semaphores) is tricky. The ordering priority I used depends on calls to p(..);
    e.g. <code>p(sLight); p(sEmpty);</code> creates <code>orderVec = ['sLight', 'sEmpty']</code> that will be used to sort each vehicle in each road.
  </pre>
  </section>
  
  <section>
    <h2>Notes</h2>
    <pre>
    This web app is supposed be <em>useful</em> (as in [2]) to students, so they can actually test their algorithms and see how they work in a dynamic system,
    and not just a viz like I did with <a href="https://djalil.me/trash/2019-11/dac-exo3/?scenario=p1,p2,p3">DAC Exo3</a>.
    
    * Why? Why not. Also, because the idea of simulating a dynamic system sounded cool (my DAC teacher mentioned it).

    * It makes use of:
      - JavaScript's <code>with</code> feature which is deprecated and very discouraged
      - <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncFunction">AsyncFunction</a>
      - <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a>
      - SillySemaphore: My stupid Promise-based and queue-based semaphore
      - <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/transition">CSS transition</a> and <code>transform: translate(..) rotate(..)</code>

    * Developed and tested with <a href="https://brave.com/dre744">Brave Browser</a> v1.1 (Chromium v79.0)
    </pre>
  </section>

  <section>
    <h2>References and Good Reads</h2>
    <p>These are some of the cool documents and topics I checked while making this...</p>
    <pre>
    - [1]: Steve Carr and Jean Mayo and Ching-kuang Shene, <i>ThreadMentor: A Pedagogical Tool for Multithreaded Programming</i> (<a href="https://pages.mtu.edu/~shene/NSF-3/e-Book/index.html">tutorial</a>)

    - [2]: B. P. Miller, <i>What to Draw? When to Draw? An Essay on Parallel Program Visualization</i>

    - Wikipedia, <i>Queueing theory</i>

    - Wikipedia, <i>Taxicab geometry</i>

    - Wikipedia, <i>Computer simulation</i>
    - Wikipedia, <i>Web-based simulation</i>
    - Wikipedia, <i>Discrete-event simulation</i>
    - SIM.JS: <a href="https://en.wikipedia.org/wiki/SIM.JS">on Wikipedia</a>, <a href="http://simjs.com/index.html">its website</a>

    - <a href="http://bit-player.org/2015/traffic-jams-in-javascript">Traffic Jams in Javascript | bit-player</a>

    - <a href="https://www.ted.com/talks/wanis_kabbaj_what_a_driverless_world_could_look_like">Wanis Kabbaj: What a driverless world could look like | TED Talk</a>
    </pre>
  </section>

  <section>
    <h2>Credits</h2>
    <ul>
      <li>'City car', 'Truck', 'Traffic lights green', and 'Traffic lights red' icons by <a href="http://delapouite.com">Delapouite</a> under CC BY 3.0.</li>
      <li><a href="https://github.com/zeit">@ZEIT</a>'s <code>async-sema</code> package (under the MIT license) heavily inspired my SillySemaphore.</li>
    </ul>
  </section>
  
  <footer>
    <p>Made by <a href="https://twitter.com/djalilhebal">@djalilhebal</a>, under CC BY 3.0, <a href="https://github.com/djalilhebal/softviz-semaphores">source code available on GitHub</a></p>
  </footer>

  <script src="index.js"></script>
  <script src="presets.js"></script>
</body>
</html>
